<div class="thermometer-container">
  <div class="thermometer-header">
    <h1>TermÃ³metro de la RelaciÃ³n</h1>
    <p>Un chequeo semanal para cuidar vuestro vÃ­nculo de forma proactiva y consciente.</p>
    <button class="add-checkup-btn" (click)="toggleFormVisibility()">
      {{ isFormVisible ? 'Cerrar Chequeo' : 'Iniciar Chequeo Semanal' }}
    </button>
  </div>

  <div *ngIf="isFormVisible" class="form-container">
    <form [formGroup]="checkupForm" (ngSubmit)="onSubmit()">
      
      <div class="rating-section">
        <h4>Valora de 1 a 5 cÃ³mo ha sido vuestra Ãºltima semana en estas Ã¡reas:</h4>
        
        <div class="rating-group">
          <label>ğŸ’ ConexiÃ³n Emocional</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('connection', star)"
                    [class.selected]="checkupForm.get('connection')?.value >= star">
              â˜…
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label>ğŸ—£ï¸ ComunicaciÃ³n</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('communication', star)"
                    [class.selected]="checkupForm.get('communication')?.value >= star">
              â˜…
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label>ğŸ’– Intimidad y Afecto</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('intimacy', star)"
                    [class.selected]="checkupForm.get('intimacy')?.value >= star">
              â˜…
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label>ğŸ¤ GestiÃ³n de Conflictos</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('conflicts', star)"
                    [class.selected]="checkupForm.get('conflicts')?.value >= star">
              â˜…
            </button>
          </div>
        </div>
      </div>

      <div class="open-questions-section">
        <div class="form-field">
          <label for="appreciation">Un aprecio: "Algo que he valorado mucho de ti esta semana ha sido..."</label>
          <textarea id="appreciation" formControlName="appreciation" rows="3" placeholder="Describe un momento o cualidad especÃ­fica..."></textarea>
          <!-- NUEVO: Mensaje de error -->
          <div *ngIf="f['appreciation'].touched && f['appreciation'].errors" class="error-message">
            <span *ngIf="f['appreciation'].errors?.['required']">Este campo es obligatorio.</span>
            <span *ngIf="f['appreciation'].errors?.['minlength']">Se requieren al menos 10 caracteres.</span>
          </div>
        </div>
        <div class="form-field">
          <label for="request">Una invitaciÃ³n: "Algo en lo que me encantarÃ­a que trabajÃ¡ramos juntos es..."</label>
          <textarea id="request" formControlName="request" rows="3" placeholder="Expresa una necesidad o un deseo de forma positiva..."></textarea>
          <!-- NUEVO: Mensaje de error -->
          <div *ngIf="f['request'].touched && f['request'].errors" class="error-message">
            <span *ngIf="f['request'].errors?.['required']">Este campo es obligatorio.</span>
            <span *ngIf="f['request'].errors?.['minlength']">Se requieren al menos 10 caracteres.</span>
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn" [disabled]="checkupForm.invalid">Guardar Chequeo</button>
    </form>
  </div>

  <div class="history-list">
    <div *ngIf="userService.thermometerCheckups().length > 0; else noHistory">
      <div *ngFor="let checkup of userService.thermometerCheckups()" class="checkup-card">
        <div class="checkup-card-header">
          <h3>Chequeo del {{ checkup.date | date:'d MMMM, yyyy' }}</h3>
        </div>
        <div class="checkup-card-ratings">
          <span>ğŸ’ {{ checkup.connection }}/5</span>
          <span>ğŸ—£ï¸ {{ checkup.communication }}/5</span>
          <span>ğŸ’– {{ checkup.intimacy }}/5</span>
          <span>ğŸ¤ {{ checkup.conflicts }}/5</span>
        </div>
        <div class="checkup-card-text">
          <p><strong>Aprecio:</strong> {{ checkup.appreciation }}</p>
          <p><strong>InvitaciÃ³n:</strong> {{ checkup.request }}</p>
        </div>
      </div>
    </div>
    <ng-template #noHistory>
      <div class="no-entries-placeholder">
        <p>AÃºn no hay chequeos guardados.</p>
        <span>Â¡Realiza tu primer chequeo semanal para empezar a construir vuestro historial!</span>
      </div>
    </ng-template>
  </div>
</div>
