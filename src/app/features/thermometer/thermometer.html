<div class="thermometer-container">
  <div class="thermometer-header">
    <h1>Termómetro de la Relación</h1>
    <p>Un chequeo semanal para cuidar vuestro vínculo de forma proactiva y consciente.</p>
    <button class="add-checkup-btn" (click)="toggleFormVisibility()">
      {{ isFormVisible ? 'Cerrar Chequeo' : 'Iniciar Chequeo Semanal' }}
    </button>
  </div>

  <div *ngIf="isFormVisible" class="form-container">
    <form [formGroup]="checkupForm" (ngSubmit)="onSubmit()">
      
      <div class="rating-section">
        <h4>Valora de 1 a 5 cómo ha sido vuestra última semana en estas áreas:</h4>
        
        <div class="rating-group">
          <label>💞 Conexión Emocional</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('connection', star)"
                    [class.selected]="checkupForm.get('connection')?.value >= star">
              ★
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label>🗣️ Comunicación</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('communication', star)"
                    [class.selected]="checkupForm.get('communication')?.value >= star">
              ★
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label>💖 Intimidad y Afecto</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('intimacy', star)"
                    [class.selected]="checkupForm.get('intimacy')?.value >= star">
              ★
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label>🤝 Gestión de Conflictos</label>
          <div class="rating-stars">
            <button type="button" *ngFor="let star of ratingOptions" 
                    (click)="setRating('conflicts', star)"
                    [class.selected]="checkupForm.get('conflicts')?.value >= star">
              ★
            </button>
          </div>
        </div>
      </div>

      <div class="open-questions-section">
        <div class="form-field">
          <label for="appreciation">Un aprecio: "Algo que he valorado mucho de ti esta semana ha sido..."</label>
          <textarea id="appreciation" formControlName="appreciation" rows="3" placeholder="Describe un momento o cualidad específica..."></textarea>
          <!-- NUEVO: Mensaje de error -->
          <div *ngIf="f['appreciation'].touched && f['appreciation'].errors" class="error-message">
            <span *ngIf="f['appreciation'].errors?.['required']">Este campo es obligatorio.</span>
            <span *ngIf="f['appreciation'].errors?.['minlength']">Se requieren al menos 10 caracteres.</span>
          </div>
        </div>
        <div class="form-field">
          <label for="request">Una invitación: "Algo en lo que me encantaría que trabajáramos juntos es..."</label>
          <textarea id="request" formControlName="request" rows="3" placeholder="Expresa una necesidad o un deseo de forma positiva..."></textarea>
          <!-- NUEVO: Mensaje de error -->
          <div *ngIf="f['request'].touched && f['request'].errors" class="error-message">
            <span *ngIf="f['request'].errors?.['required']">Este campo es obligatorio.</span>
            <span *ngIf="f['request'].errors?.['minlength']">Se requieren al menos 10 caracteres.</span>
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn" [disabled]="checkupForm.invalid">Guardar Chequeo</button>
    </form>
  </div>

  <div class="history-list">
    <div *ngIf="userService.thermometerCheckups().length > 0; else noHistory">
      <div *ngFor="let checkup of userService.thermometerCheckups()" class="checkup-card">
        <div class="checkup-card-header">
          <h3>Chequeo del {{ checkup.date | date:'d MMMM, yyyy' }}</h3>
        </div>
        <div class="checkup-card-ratings">
          <span>💞 {{ checkup.connection }}/5</span>
          <span>🗣️ {{ checkup.communication }}/5</span>
          <span>💖 {{ checkup.intimacy }}/5</span>
          <span>🤝 {{ checkup.conflicts }}/5</span>
        </div>
        <div class="checkup-card-text">
          <p><strong>Aprecio:</strong> {{ checkup.appreciation }}</p>
          <p><strong>Invitación:</strong> {{ checkup.request }}</p>
        </div>
      </div>
    </div>
    <ng-template #noHistory>
      <div class="no-entries-placeholder">
        <p>Aún no hay chequeos guardados.</p>
        <span>¡Realiza tu primer chequeo semanal para empezar a construir vuestro historial!</span>
      </div>
    </ng-template>
  </div>
</div>
